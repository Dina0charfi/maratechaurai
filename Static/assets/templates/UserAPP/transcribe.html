{% extends "UserAPP/base.html" %}

{% block title %}Voice-to-Text{% endblock %}

{% block content %}

    <!-- ***** Header ***** -->
    <header class="header-area header-sticky">
        <div class="container">
            <nav class="main-nav">
                <a href="#" class="logo">Voice-to-Text</a>
                <ul class="nav">
                    <li><a href="#record" class="menu-item">ุชุณุฌูู ุงูุตูุช</a></li>
                    <li><a href="#result" class="menu-item">ุงููุต ุงููุณุชุฎุฑุฌ</a></li>
                </ul>
                <a class='menu-trigger'><span>Menu</span></a>
            </nav>
        </div>
    </header>

    <!-- ***** Section Enregistrement ***** -->
    <section class="section" id="record">
        <div class="container">
            <div class="row">
                <div class="col-lg-6 offset-lg-3">
                    <div class="text-center">
                        <h2>๐ค ุชุณุฌูู ุงูุตูุช ู ุชุญูููู ุฅูู ูุต</h2>
                        <p>ุงุจุฏุฃ ุงูุชุณุฌูู ูู ุงููููุฑูููู ุซู ุฃุฑุณูู ููุชูุฑูุบ.</p>

                        <button id="start" class="btn btn-primary">ุงุจุฏุฃ ุงูุชุณุฌูู</button>
                        <button id="stop" class="btn btn-danger" disabled>ุฃููู ุงูุชุณุฌูู</button>

                        <p id="status" class="mt-2"></p>

                        <form id="uploadForm" method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                            <input type="file" name="audio" id="audioFile" hidden>
                            <button type="submit" class="btn btn-success mt-2">ุงุฑุณุงู ุงูุตูุช ููุชูุฑูุบ</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ***** Section Rรฉsultat ***** -->
    <section class="section" id="result">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 offset-lg-2">
                    <div class="text-center">
                        <h3>ุงููุต ุงููุณุชุฎุฑุฌ</h3>
                        <pre class="border p-3" style="background-color: #f8f9fa;">{{ text }}</pre>
                        <p style="color:red;">{{ error }}</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

{% endblock %}

{% block extra_js %}
    <script>
        let mediaRecorder;
        let audioChunks = [];

        const startBtn = document.getElementById("start");
        const stopBtn = document.getElementById("stop");
        const audioFileInput = document.getElementById("audioFile");
        const status = document.getElementById("status");

        startBtn.onclick = async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            {% load static %}
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = e => {
                audioChunks.push(e.data);
            };

            mediaRecorder.onstop = e => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const file = new File([audioBlob], "recorded.webm", { type: 'audio/webm' });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                audioFileInput.files = dataTransfer.files;
                status.innerText = "โ ุงูุชุณุฌูู ุงูุชูู. ููููู ุงูุขู ุฅุฑุณุงู ุงูุตูุช.";
            };

            mediaRecorder.start();
            startBtn.disabled = true;
            stopBtn.disabled = false;
            status.innerText = "โณ ุงูุชุณุฌูู ุฌุงุฑู...";
        };

        stopBtn.onclick = () => {
            mediaRecorder.stop();
            mediaRecorder.stream.getTracks().forEach(t => t.stop());
            startBtn.disabled = false;
            stopBtn.disabled = true;
        };
    </script>
{% endblock %}
